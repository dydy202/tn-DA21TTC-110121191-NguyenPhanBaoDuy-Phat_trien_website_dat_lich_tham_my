<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lịch Sử Lịch Hẹn - Tiệm Nail Diamond</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #fffaf0;
      }
      .navbar {
        background-color: #d8beaa !important;
      }
      .navbar .nav-link {
        color: #000000 !important;
      }
      .navbar .nav-link:hover {
        color: #ffffff !important;
      }
      .navbar .navbar-brand {
        color: #000000 !important;
      }
      .main-content {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .table th,
      .table td {
        vertical-align: middle;
      }
      .table img {
        max-width: 100px;
        border-radius: 5px;
      }
      .alert {
        margin-bottom: 20px;
      }
      .footer {
        background: #d8bea2;
        color: #000;
        padding: 20px 0;
        margin-top: auto;
      }
      .footer-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      .footer-grid > div {
        flex: 1 1 300px;
        padding: 15px;
      }
      .footer-grid h2 {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .footer-grid h3 {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .footer-grid p {
        font-size: 0.9em; /* Giảm kích thước chữ */
        margin-bottom: 5px;
      }
      .footer-grid a {
        color: #000;
        text-decoration: none;
        transition: color 0.3s ease;
      }
      .footer-grid a:hover {
        color: #fff;
      }
      .navbar-logo {
        border-radius: 50px;
      }
      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        padding: 10px 0;
        background-color: #fffaf0;
      }
      .pagination .page-item {
        margin: 0 5px;
      }
      .pagination .page-link {
        color: #d8beaa;
        background-color: #fff;
        border: 1px solid #d8beaa;
        border-radius: 5px;
        padding: 5px 10px;
        text-decoration: none;
      }
      .pagination .page-item.active .page-link {
        background-color: #d8beaa;
        color: #fff;
        border-color: #d8beaa;
      }
      .pagination .page-link:hover {
        background-color: #d8beaa;
        color: #fff;
      }
      .btn-cancel {
        color: #fff;
        background-color: #dc3545;
        border-color: #dc3545;
      }
      .btn-cancel:hover {
        background-color: #c82333;
        border-color: #bd2130;
      }
      .btn-rate {
        color: #fff;
        background-color: #28a745;
        border-color: #28a745;
      }
      .btn-rate:hover {
        background-color: #218838;
        border-color: #1e7e34;
      }
    </style>
  </head>
  <body>
    <!-- Menu -->
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container">
        <a class="navbar-brand" href="/trangchu">
          <img
            src="/uploads/logo.png"
            alt="Tiệm Nail Diamond"
            class="navbar-logo"
            style="max-height: 80px"
          />
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/trangchu">Trang chủ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/gioithieu">Giới thiệu</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/dichvu">Dịch vụ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/hocvien">Học viện</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/tintuc">Tin tức</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/album">Album</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/datlich?redirect=/datlich">Đặt lịch</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/lienhe">Liên hệ</a>
            </li>
            <% if (user) { %>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <%= user.HoTenKH || 'Tài khoản' %>
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                <li>
                  <a class="dropdown-item" href="/taikhoan">Sửa thông tin</a>
                </li>
                <li>
                  <a class="dropdown-item" href="/lichsu-lichhen"
                    >Lịch sử lịch hẹn</a
                  >
                </li>
                <li><a class="dropdown-item" href="/dangxuat">Đăng xuất</a></li>
              </ul>
            </li>
            <% } else { %>
            <li class="nav-item">
              <a class="nav-link" href="/dangnhap">Đăng nhập/Đăng ký</a>
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Nội dung chính -->
    <div class="main-content">
      <h2 class="text-center mb-4">Lịch Sử Lịch Hẹn</h2>

      <!-- Hiển thị thông báo -->
      <% if (message && message.text) { %>
      <div
        class="alert alert-<%= message.type %> alert-dismissible fade show"
        role="alert"
      >
        <%= message.text %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %>

      <!-- Bảng lịch hẹn -->
      <% if (appointments && appointments.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>Ngày Hẹn</th>
              <th>Giờ Hẹn</th>
              <th>Dịch Vụ</th>
              <th>Nhân Viên</th>
              <th>Trạng Thái</th>
              <th>Hình Thức Thanh Toán</th>
              <th>Số Tiền Thanh Toán</th>
              <th>Hình Ảnh</th>
              <th>Ghi Chú</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody>
            <% appointments.forEach(appointment => { %>
            <tr>
              <td>
                <%= new Date(appointment.NgayHen).toLocaleDateString('vi-VN') %>
              </td>
              <td>
                <% if (appointment.GioHen) { %> <%= new
                Date(appointment.GioHen).toISOString().slice(11, 16) %> <% }
                else { %> Không xác định <% } %>
              </td>
              <td><%= appointment.TenSP || 'Không xác định' %></td>
              <td><%= appointment.HoTenNV || 'Không xác định' %></td>
              <td><%= appointment.TrangThaiLH %></td>
              <td><%= appointment.HinhThucThanhToan || 'Chưa chọn' %></td>
              <td>
                <%= appointment.SoTienThanhToan ?
                appointment.SoTienThanhToan.toLocaleString('vi-VN') + ' VND' :
                '0 VND' %>
              </td>
              <td>
                <% if (appointment.HinhAnhLH) { %>
                <img
                  src="<%= appointment.HinhAnhLH %>"
                  alt="Hình ảnh lịch hẹn"
                />
                <% } else { %> Không có <% } %>
              </td>
              <td><%= appointment.GhiChuLH || 'Không có' %></td>
              <td>
                <% const appointmentDateTime = new Date(appointment.NgayHen); if
                (appointment.GioHen) { const time = new
                Date(appointment.GioHen);
                appointmentDateTime.setUTCHours(time.getUTCHours(),
                time.getUTCMinutes()); } const currentDateTime = new Date();
                const timeDiff = (appointmentDateTime - currentDateTime) / (1000
                * 60 * 60); const canCancel = timeDiff >= 24 && ['Chờ xác nhận',
                'Đã xác nhận'].includes(appointment.TrangThaiLH); %> <% if
                (canCancel) { %>
                <a
                  href="/huy-lichhen?maLH=<%= appointment.MaLH %>"
                  class="btn btn-cancel btn-sm"
                  onclick="return confirm('Bạn có chắc chắn muốn hủy lịch hẹn này?')"
                >
                  Hủy
                </a>
                <% } %> <% if (appointment.TrangThaiLH === 'Hoàn thành' &&
                appointment.MaCTHD && !appointment.HasDanhGia) { %>
                <a
                  href="/danhgia?maCTHD=<%= appointment.MaCTHD %>"
                  class="btn btn-rate btn-sm"
                >
                  Đánh giá
                </a>
                <% } %>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <!-- Phân trang cho Lịch Sử Lịch Hẹn -->
      <nav aria-label="Lịch Sử Lịch Hẹn Page navigation">
        <div class="pagination justify-content-center">
          <% if (typeof totalPages !== 'undefined' && typeof currentPage !==
          'undefined' && totalPages > 0) { %> <% for (let i = 1; i <=
          totalPages; i++) { %> <% if (i === 1 || i === totalPages || (i >=
          currentPage - 1 && i <= currentPage + 1)) { %>
          <li class="page-item <%= i === currentPage ? 'active' : '' %>">
            <a class="page-link" href="/lichsu-lichhen?page=<%= i %>"
              ><%= i %></a
            >
          </li>
          <% } else if (i === currentPage - 2 || i === currentPage + 2) { %>
          <li class="page-item disabled">
            <span class="page-link">...</span>
          </li>
          <% } %> <% } %> <% if (currentPage < totalPages) { %>
          <li class="page-item">
            <a
              class="page-link"
              href="/lichsu-lichhen?page=<%= currentPage + 1 %>"
              >Next Page »</a
            >
          </li>
          <% } %> <% } else { %>
          <p class="text-center">Không có phân trang cho lịch sử lịch hẹn.</p>
          <% } %>
        </div>
      </nav>
      <% } else { %>
      <p class="text-center text-muted">Bạn chưa có lịch hẹn nào.</p>
      <% } %>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-grid">
          <div>
            <h2>Tiệm nail Diamond</h2>
            <h3>Địa chỉ</h3>
            <p>Hẻm 300, Khóm 1, Phường 8, Thành phố Trà Vinh, tỉnh Trà Vinh</p>
            <h3>Liên hệ</h3>
            <p>Điện thoại: 0784265668</p>
            <p>Email: npb.duy.2002@gmail.com</p>
          </div>
          <div>
            <h3>Bản đồ</h3>
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m16!1m12!1m3!1d245.63861717762805!2d106.31644629814373!3d9.915804120820384!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!2m1!1zaOG6u20gMzAwIEtow7NtIDEgcGjGsOG7nW5nIDggVGjDoG5oIHBo4buRIFRyw6AgVmluaA!5e0!3m2!1svi!2s!4v1744661746153!5m2!1svi!2s"
              width="100%"
              height="200"
              style="border: 0; border-radius: 10px"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
            ></iframe>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Thêm mã Crisp -->
    <script type="text/javascript">
      window.CRISP_WEBSITE_ID = "1943f314-1b1a-49aa-9069-02eb9fe4db8a";
      (function () {
        var d = document;
        var s = d.createElement("script");
        s.src = "https://client.crisp.chat/l.js";
        s.async = 1;
        d.getElementsByTagName("head")[0].appendChild(s);
      })();
    </script>
  </body>
</html>
